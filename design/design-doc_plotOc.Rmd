---
title: "Design Document for plotOc"
output: html_document
date: "2025-03-05"
editor_options:
  chunk_output_type: console
---
# Purpose 
Plot a bar plot for simulated results of :
- `ocPostprob()` with cases
  1. `length(nnE) = length(nnF)` AND `wiggle = FALSE` ✔️
  2. `length(nnE) = length(nnF)` AND `wiggle = TRUE`. (looks wiggle together)
  3. `length(nnE) =! length(nnF)` AND `wiggle = FALSE`. (looks are different and don't wiggle)
  4. `length(nnE) =! length(nnF)` AND `wiggle = TRUE`. (looks are different and wiggle)
- `ocPredprob()`
- others

Note these results and definitions :
FALSE = met the futility criteria
TRUE = met the efficacy criteria

which can be improved in future PR, e.g "Go" as factor for "met the efficacy criteria". 

## Important packages

```{r}
library(dplyr)
```

### Input parameters :

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

input <- list(
  nn = c(10, 20, 30),
  nnE = c(10, 20, 30),
  nnF = c(10, 20, 30),
  p0 = 0.2,
  p1 = 0.3,
  parE = c(1, 1),
  truep = 0.4,
  tU = 0.8,
  tL = 0.6,
  wiggle = TRUE,
  sim = 100
)
```

# `ocPostprob()` 

## 1. `ocPostprob()` where `length(nnE) = length(nnF)` AND `wiggle = FALSE`

```{r}
# Here, we only have one Futility but many Efficacy looks or stop.
res1 <- ocPostprob(
  nnE = c(10, 20, 30), truep = 0.40, p0 = 0.20, p1 = 0.30, tL = 0.60, tU = 0.80, parE = c(1, 1),
  sim = 100, wiggle = FALSE, nnF = c(10, 20, 30)
)

res1 # (may need to add wiggled distance)
res1$oc
```

## 2. `ocPostprob()` where `length(nnE) = length(nnF)` AND `wiggle = TRUE`. (looks wiggle together)

```{r}
# Here, we only have one Futility but many Efficacy looks or stop.
res2 <- ocPostprob(
  nnE = c(10, 20, 30), truep = 0.40, p0 = 0.20, p1 = 0.30, tL = 0.60, tU = 0.80, parE = c(1, 1),
  sim = 100, wiggle = TRUE, nnF = c(10, 20, 30)
)

res2 # (may need to add wiggled distance as param)
res2$oc
```

## 3. `ocPostprob()` where `length(nnE) =! length(nnF)` AND `wiggle = FALSE`. (looks are different and don't wiggle)
```{r}
res3 <- ocPostprob(
  nnE = c(10, 20, 30), truep = 0.40, p0 = 0.20, p1 = 0.30, tL = 0.60, tU = 0.80, parE = c(1, 1),
  sim = 100, wiggle = FALSE, nnF = 30
)

res3 # (may need to add wiggled distance)
res3$oc
```

## 4. `ocPostprob()` where `length(nnE) =! length(nnF)` AND `wiggle = TRUE`. (looks are different and wiggle)

```{r}
res4 <- ocPostprob(
  nnE = c(10, 20, 30), truep = 0.40, p0 = 0.20, p1 = 0.30, tL = 0.60, tU = 0.80, parE = c(1, 1),
  sim = 100, wiggle = TRUE, nnF = 30
)

res4 
res4$oc
```

### Helper function

```{r}

h_get_dataframe <- function(decision, sample_size, all_looks) {
  df <- data.frame(decision = decision,
                      sample_size = sample_size,
                      look = all_looks)
  # summarise into frequency table
  df <- df %>%  
  group_by(decision, look) %>% 
    summarise(prop = sum(length(decision))/nrow(df)) %>% 
    as_tibble()
  # setting levels of factors
  all_decision <- c(TRUE, FALSE, NA)
  all_looks <- c(10, 20, 30)
  df$decision <- factor(df$decision, levels = all_decision)
  df$look <- factor(df$look, levels = all_looks)
  # data input for plot, such that all variables present, even empty cases
  df <- df %>%
    complete(decision, look, 
             fill = list(prop = 0))
  df

                       }
```

# Example for case 1
```{r}
h_get_dataframe(res1$Decision, sample_size = res1$SampleSize, res1$Looks)
```

# Example for case 2
```{r}
h_get_dataframe(res2$Decision, sample_size = res2$SampleSize, res2$Looks)
```

# Example for case 3
```{r}
h_get_dataframe(res3$Decision, sample_size = res3$SampleSize, res3$Looks)
```

# Example for case 4
```{r}
h_get_dataframe(res4$Decision, sample_size = res4$SampleSize, res4$Looks)
```

## Testing helper function

```{r}
# h_get_dataframe ----
test_that("h_get_dataframe gives correct data frame", {
  set.seed(1989)
  res4 <- ocPostprob(
    nnE = c(10, 20, 30), 
    truep = 0.40, 
    p0 = 0.20, 
    p1 = 0.30, 
    tL = 0.60, 
    tU = 0.80, 
    parE = c(1, 1),
    sim = 100, 
    wiggle = TRUE, 
    nnF = 30
  )
  result <- h_get_dataframe(res4$Decision, sample_size = res4$SampleSize, res4$Looks)
  expect_equal(result$decision, TRUE)
  expect_equal(result$all_sizes, 20)
})

```

## User facing function

```{r}
plotOc <- function(decision, sample_size, all_looks, wiggle_status) {
  df <- h_get_dataframe(decision = decision, 
                        sample_size = sample_size, 
                        all_looks = all_looks)
  barplot <-   
    ggplot2::ggplot(df, aes(fill = decision, x = look, y = prop)) +
    ggplot2::geom_bar(position = "dodge", stat = "identity") + 
    ggplot2::ggtitle("Results from simulation : \nProportion of Go/Stop/Grey zone decisions per interim/final analysis") +
    ggplot2::ylab("percentage") +
    ggplot2::xlab("look (n)") +
    scale_fill_manual(values = c("#009E73", "#FF0046", "lightgrey"),
                      labels = c("Go", "Stop", "Grey zone")) 
    if (wiggle_status) {
        wiggle_warning <- 
          paste("Note that sample sizes slightly differ from the ones labeled")
        barplot + ggplot2::annotate("text", 
                                    label = wiggle_warning, 
                                    x = length(unique(all_looks))/1.5, 
                                    y = 0.65, 
                                    size = 5,
                                    colour = "black") 
      
    } else {
      barplot
    }                               
}
```

```{r}
plotOc(decision = res2$Decision, 
       sample_size = res2$SampleSize,
       all_looks = res2$Looks,
       wiggle_status = res2$params$wiggle)
```

```{r}
plotOc(decision = res1$Decision, 
       sample_size = res1$SampleSize,
       all_looks = res1$Looks,
       wiggle_status = res1$params$wiggle)
```

```{r}
plotOc(decision = res3$Decision, 
       sample_size = res3$SampleSize,
       all_looks = res3$Looks,
       wiggle_status = res3$params$wiggle)
```

```{r}
plotOc(decision = res4$Decision, 
       sample_size = res4$SampleSize,
       all_looks = res4$Looks,
       wiggle_status = res4$params$wiggle)
```


