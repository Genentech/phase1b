---
title: "Design document for ocPostprobDist.R"
output: html_document
date: "2023-12-19"
---
## Input parameters from example file :

# design details
# multiple looks @ 10, 20, 30 patients
# True response rate of the treatment group=0.4

# stop for efficacy (deltaE): P(pE > pS + deltaE) >tU
# stop for futility (deltaF): P(pE < pS - deltaF) >tL
# where pE is the response rate of treatment group, pS is the response rate of
# control group. Both of them are random variables.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

nn <- c(10, 20, 30)
truep <- 0.4
deltaE <- 0.1
deltaF <- -0.1
tL <- 0.6
tU <- 0.6
parE <- c(1, 1)
parS <- c(5, 25)
sim <- 100
randomdist <- TRUE
dist <- 5
relativeDelta <- FALSE
```

# Adapted h_get_decision as helper function

```{r}
h_get_decisionDist <- function(nnr,
                               truep,
                               p0,
                               p1,
                               parE = c(1, 1),
                               nnE,
                               nnF,
                               tL,
                               tU) {
  index_look <- 1
  assert_numeric(nnr)
  size_look <- nnr[index_look]
  all_sizes <- decision <- NA
  response <- stats::rbinom(max(nnr), size = 1, truep)
  assert_numeric(response, lower = 0, upper = 1)
  while (is.na(decision) && index_look <= length(nnr)) {
    # Go criteria is P_E(p > p1) > tU, where P_E(truep > 0.30) > 0.2
    # Stop criteria is P_E(p < p0) > tL, where P_E(truep > 0.20) > 0.3
    if (size_look %in% nnF) {
      qL <- postprobDist( # P(P_E < P_S + delta or P_S(1-PS)*delta | data)  >= tL
        x = 0,
        n = 0,
        xS = sum(response[1:i]),
        nS = i,
        delta = deltaF,
        relativeDelta = relativeDelta,
        parE = parS,
        parS = parE
      )
      s[k] <- ifelse(qL >= tL, FALSE, NA)
    }
    if (i %in% nnrE) {
      qU <- postprobDist( #  P(P_E > P_S + delta or P_S(1-PS)*delta | data) =< tU
        x = sum(response[1:i]),
        n = i,
        xS = 0,
        nS = 0,
        delta = deltaE,
        relativeDelta = relativeDelta,
        parE = parE,
        parS = parS
      )
      s[k] <- ifelse(qU < tU, s[k], TRUE)
    }
    all_sizes <- size_look
    index_look <- index_look + 1
    size_look <- nnr[index_look]
  }
  list(
    decision = decision,
    all_sizes = all_sizes
  )
}
```

## Main Function

```{r cars}
ocPostprobDist <- function(nn,
                           truep,
                           deltaE,
                           deltaF,
                           relativeDelta = FALSE,
                           tL,
                           tU,
                           parE = c(a = 1, b = 1),
                           parS = c(a = 1, b = 1),
                           sim = 50000,
                           randomdist = FALSE,
                           dist = NULL,
                           nnF = nn) {
  if (sim < 50000) {
    warning("Advise to use sim >= 50000 to achieve convergence")
  }
  nnE <- sort(nn)
  nnF <- sort(nnF)
  decision <- rep(NA, sim)
  all_sizes <- decision
  nn <- sort(unique(c(nnF, nnE)))
  nL <- length(nn)
  Nstart <- nn[1]
  Nmax <- nn[nL]
  ## simulate a clinical trial ns times
  for (k in 1:ns) {
    if (nr && (d > 0)) {
      ## randomly generate look locations
      dist <- h_get_distance(nn = nn) # we generate sim number of distances ?
      nnr <- h_get_looks(dist = dist, nnE = nnE, nnF = nnF) # we generate sim number of looks
      nnrE <- nnr$nnrE
      nnrF <- nnr$nnrF
    } else {
      nnrE <- nnE
      nnrF <- nnF
    }
    nnr <- unique(c(nnrE, nnrF))
    tmp <- h_get_decisionDist(
      nnr = nnr,
      truep = truep,
      p0 = p0,
      p1 = p1,
      parE = c(1, 1),
      nnE = nnrE,
      nnF = nnrF,
      tL = tL,
      tU = tU
    )
    decision[k] <- tmp$decision
    all_sizes[k] <- tmp$all_sizes
    oc <- h_get_oc(all_sizes = all_sizes, nnr = nnr, decision = decision, nnrE = nnrE, nnrF = nnrF)
    list(
      oc = oc,
      Decision = decision,
      SampleSize = all_sizes,
      nn = nn,
      nnE = nnE,
      nnF = nnF
    )
  }
}
```

## Example

```{r pressure, echo=FALSE}
res3 <- ocPostprobDist(
  nn = c(10, 20, 30),
  truep = 0.4,
  deltaE = 0.1,
  deltaF = -0.1,
  tL = 0.6,
  tU = 0.6,
  parE = c(1, 1),
  parS = c(5, 25),
  sim = 100,
  randomdist = TRUE,
  dist = 5
)

res3$oc
```
