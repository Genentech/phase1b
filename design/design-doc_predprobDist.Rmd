---
title: "Design Document"
output: html_document
date: "2023-12-04"
---

## Example inputs / Sanity check

```{r setup, include=FALSE}
x <- 16
n <- 23
xS <- 5
nS <- 10
Nmax <- 40
NmaxControl <- 20
delta <- 0
thetaT <- 0.6
parE <- c(1, 1)
parS <- c(1, 1)
weights <- c(2, 1)
weightsS <- c(2, 1)
relativeDelta <- FALSE

# helper test
mE <- Nmax - n
parE <- t(parE)
weights <- rep(1, nrow(parE))
parS <- t(parS)
weightsS <- rep(1, nrow(parS))

activeBetamixPost <- h_getBetamixPost(x = x, n = n, par = parE, weights = weights)
# now with the beta binomial mixture:
py <- with(activeBetamixPost, dbetabinomMix(x = 0:mE, m = mE, par = par, weights = weights)
```

```{r}
predprobDist(
  x = 16, n = 23, Nmax = 40, delta = 0, thetaT = 0.9,
  parE = c(0.6, 0.4), parS = c(7, 11)
)
```
## R Markdown

# helper if NmaxControl == 0, or when there is no control
```{r}
h_get_table_singlearm <- function(
    n,
    x,
    mE,
    delta,
    relativeDelta,
    parE,
    weights ,
    parS,
    weightsS ,
    thetaT ,
    b,
    py,
    Nmax) {
  b <- postprobDist(
    x = x + c(0:mE),
    n = Nmax,
    delta = delta,
    relativeDelta = relativeDelta,
    parE = parE,
    weights = weights,
    parS = parS,
    weightsS = weightsS
  )

  ret <- structure(sum(py * (b > thetaT)),
                   tables =
                     round(
                       cbind(
                         i = c(0:mE),
                         py,
                         b,
                         bgttheta = (b > thetaT)
                       ),
                       4
                     )
  )

}

```

```{r}
h_get_predproblist_control(x = x,
                           Nmax = Nmax,
                           delta = delta,
                           relativeDelta = relativeDelta,
                           parE = parE,
                           weights = weights,
                           parS = parS,
                           weightsS = weightsS,
                           thetaT = thetaT,
                           density = 0.77,
                           mE = 17)
```



```{r cars}
predprobDist <- function(x, n,
                         xS = 0, nS = 0,
                         Nmax,
                         NmaxControl = 0,
                         delta = 0,
                         relativeDelta = FALSE,
                         parE = c(a = 1, b = 1),
                         weights,
                         parS = c(a = 1, b = 1),
                         weightsS,
                         thetaT) {
  stopifnot(
    n <= Nmax,
    nS <= NmaxControl,
    x <= n,
    xS <= nS
  )
  mE <- Nmax - n
  if (is.vector(parE)) {
    stopifnot(identical(length(parE), 2L))
    parE <- t(parE)
  }
  if (missing(weights)) {
    weights <- rep(1, nrow(parE))
  }
  if (is.vector(parS)) {
    stopifnot(identical(length(parS), 2L))
    parS <- t(parS)
  }
  if (missing(weightsS)) {
    weightsS <- rep(1, nrow(parS))
  }
  activeBetamixPost <- h_getBetamixPost(x = x, n = n, par = parE, weights = weights)
  py <- with(
    activeBetamixPost,
    dbetabinomMix(x = 0:mE, m = mE, par = par, weights = weights)
  )
  if (NmaxControl == 0) {
    h_get_table_singlearm(
      x = x,
      n = Nmax,
      mE = mE,
      delta = delta,
      relativeDelta = relativeDelta,
      parE = parE,
      weights = weights,
      parS = parS,
      weightsS = weightsS,
      thetaT = thetaT,
      b = b,
      py = py,
      Nmax)
    # b <- postprobDist(
    #   x = x + c(0:mE),
    #   n = Nmax,
    #   delta = delta,
    #   relativeDelta = relativeDelta,
    #   parE = parE,
    #   weights = weights,
    #   parS = parS,
    #   weightsS = weightsS
    # )
    #
    # ret <- structure(sum(py * (b > thetaT)),
    #                  tables =
    #                    round(
    #                      cbind(
    #                        i = c(0:mE),
    #                        py,
    #                        b,
    #                        bgttheta = (b > thetaT)
    #                      ),
    #                      4
    #                    )
    # )
  } else {
    mS <- NmaxControl - nS
    controlBetamixPost <- h_getBetamixPost(
      x = xS, n = nS, par = parS,
      weights = weightsS
    )
    pz <- with(
      controlBetamixPost,
      dbetabinomMix(x = 0:mS, m = mS, par = par, weights = weights)
    )
    ## determine resulting posterior probabilities:
    outcomesY <- x + c(0:mE)
    outcomesZ <- xS + c(0:mS)
    pyz <- b <- matrix(
      nrow = 1 + mE,
      ncol = 1 + mS,
      dimnames =
        list(
          0:mE,
          0:mS
        )
    )
    for (i in seq_along(outcomesY)) {
      for (j in seq_along(outcomesZ)) {
        b[i, j] <-
          postprobDist(
            x = outcomesY[i],
            n = Nmax,
            xS = outcomesZ[j],
            nS = NmaxControl,
            delta = delta,
            relativeDelta = relativeDelta,
            parE = parE,
            weights = weights,
            parS = parS,
            weightsS = weightsS
          )
        pyz[i, j] <- py[i] * pz[j]
      }
    }
    ret <- structure(sum(pyz * (b > thetaT)),
                     tables =
                       list(
                         pyz = pyz,
                         b = b,
                         bgttheta = (b > thetaT)
                       )
    )
  }
  ret
}

```



```{r pressure, echo=FALSE}
predprobDist(
  x = 16, n = 23, Nmax = 40, delta = 0.1, thetaT = 0.9,
  parE = rbind(c(1, 1), c(50, 10)),
  weights = c(2, 1), parS = c(6, 11)
)
```
