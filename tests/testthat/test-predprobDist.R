# h_predprobdist_single_arm ----
test_that("h_predprobdist gives correct predictive probability", {
  result <- h_predprobdist_single_arm( # From Lee & Liu (2008) example
    x = 16,
    Nmax = 40,
    delta = 0.1,
    relativeDelta = FALSE,
    parE = c(0.6, 0.4),
    weights = 1,
    parS = c(7, 11),
    weightsS = 1,
    thetaT = 0.9,
    density = dbetabinomMix(x = 0:17, m = 17, par = t(c(0.6, 0.4)), weights = 1),
    mE = 17
  )
  expect_equal(result$result, 0.5426927, tolerance = 1e-4)
})

test_that("h_predprobdist_single_arm gives higher predictive probability when thetaT is lower", {
  is_lower <- h_predprobdist_single_arm( # From Lee & Liu (2008) example
    x = 16,
    Nmax = 40,
    delta = 0.1,
    relativeDelta = FALSE,
    parE = c(0.6, 0.4),
    weights = 1,
    parS = c(7, 11),
    weightsS = 1,
    thetaT = 0.9,
    density = dbetabinomMix(x = 0:17, m = 17, par = t(c(0.6, 0.4)), weights = 1),
    mE = 17
  )
  is_higher <- h_predprobdist_single_arm( # From Lee & Liu (2008) example
    x = 16,
    Nmax = 40,
    delta = 0.1,
    relativeDelta = FALSE,
    parE = c(0.6, 0.4),
    weights = 1,
    parS = c(7, 11),
    weightsS = 1,
    thetaT = 0.5,
    density = dbetabinomMix(x = 0:17, m = 17, par = t(c(0.6, 0.4)), weights = 1),
    mE = 17
  )
  expect_true(is_higher$result > is_lower$result, )
})

test_that("h_predprobdist gives correct list", {
  result <- h_predprobdist_single_arm( # From Lee & Liu (2008) example
    x = 16,
    Nmax = 40,
    delta = 0.1,
    relativeDelta = FALSE,
    parE = c(0.6, 0.4),
    weights = 1,
    parS = c(7, 11),
    weightsS = 1,
    thetaT = 0.9,
    density = dbetabinomMix(x = 0:17, m = 17, par = t(c(0.6, 0.4)), weights = 1),
    mE = 17
  )
  expected <- list(
    result = 0.54269272350537,
    table = data.frame(
      counts = 0:17,
      cumul_counts = c(
        16, 17, 18, 19, 20, 21, 22, 23, 24, 25,
        26, 27, 28, 29, 30, 31, 32, 33
      ),
      density = c(
        0.081783685071388,
        0.0508654626663511, 0.0422777871512528, 0.0381674467337698,
        0.0358887931974255, 0.0346153198904199, 0.0340080335765529,
        0.0339146049128812, 0.0342753985821671, 0.0350914795007901,
        0.0364192652116307, 0.0383850778224858, 0.0412284169204477,
        0.0454089207340597, 0.0518959094103539, 0.0631400231159307,
        0.0879450321971892, 0.214689343304903
      ),
      posterior = c(
        0.273531410553188,
        0.337791887816968, 0.4060867759263, 0.476483339905221, 0.546948408163723,
        0.615503378263203, 0.68036482033612, 0.74005747797379, 0.793490884253671,
        0.839995719658816, 0.879320792671476, 0.91159559002206, 0.93726634490541,
        0.957015305250502, 0.971673319374667, 0.982135113639861,
        0.989284955003113, 0.993938086698407
      ),
      success = c(
        FALSE,
        FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,
        FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE
      )
    )
  )
  expect_equal(result, expected)
})

test_that("sum of density in h_predprobdist_single_arm is 1", {
  result <- h_predprobdist_single_arm( # From Lee & Liu (2008) example
    x = 16,
    Nmax = 40,
    delta = 0.1,
    relativeDelta = FALSE,
    parE = c(0.6, 0.4),
    weights = 1,
    parS = c(7, 11),
    weightsS = 1,
    thetaT = 0.9,
    density = dbetabinomMix(x = 0:17, m = 17, par = t(c(0.6, 0.4)), weights = 1),
    mE = 17
  )
  expect_equal(sum(result$table$density), 1, tolerance = 1e-4)
})

test_that("h_predprobdist give predictive probability less than 1 or 1", {
  result <- h_predprobdist_single_arm( # From Lee & Liu (2008) example
    x = 16,
    Nmax = 40,
    delta = 0.1,
    relativeDelta = FALSE,
    parE = c(0.6, 0.4),
    weights = 1,
    parS = c(7, 11),
    weightsS = 1,
    thetaT = 0.9,
    density = dbetabinomMix(x = 0:17, m = 17, par = t(c(0.6, 0.4)), weights = 1),
    mE = 17
  )
  expect_true(all(result$posterior <= 1))
})

# h_predprobdist ----
test_that("h_predprobdist gives correct predictive probability", {
  result <- h_predprobdist(
    NmaxControl = 20,
    Nmax = 40,
    n = 23,
    nS = 10,
    x = 16,
    xS = 5,
    parE = rbind(c(1, 1), c(50, 10)),
    parS = rbind(c(1, 1), c(20, 40)),
    weights = c(2, 1),
    weightsS = c(2, 1),
    delta = 0.1,
    relativeDelta = FALSE,
    thetaT = 0.9
  )
  expect_equal(result$result, 0.6140843, tolerance = 1e-4)
})

test_that("h_predprobdist gives higher predictive probability when thetaT is lower", {
  is_lower <- h_predprobdist(
    NmaxControl = 20,
    Nmax = 40,
    n = 23,
    nS = 10,
    x = 16,
    xS = 5,
    parE = rbind(c(1, 1), c(50, 10)),
    parS = rbind(c(1, 1), c(20, 40)),
    weights = c(2, 1),
    weightsS = c(2, 1),
    delta = 0.1,
    relativeDelta = FALSE,
    thetaT = 0.9
  )
  is_higher <- h_predprobdist(
    NmaxControl = 20,
    Nmax = 40,
    n = 23,
    nS = 10,
    x = 16,
    xS = 5,
    parE = rbind(c(1, 1), c(50, 10)),
    parS = rbind(c(1, 1), c(20, 40)),
    weights = c(2, 1),
    weightsS = c(2, 1),
    delta = 0.1,
    relativeDelta = FALSE,
    thetaT = 0.5
  )
  expect_true(is_higher$result > is_lower$result)
})

test_that("h_predprobdist gives correct list", {
  result <- h_predprobdist(
    NmaxControl = 20,
    Nmax = 40,
    n = 23,
    nS = 10,
    x = 16,
    xS = 5,
    parE = rbind(c(1, 1), c(50, 10)),
    parS = rbind(c(1, 1), c(20, 40)),
    weights = c(2, 1),
    weightsS = c(2, 1),
    delta = 0.1,
    relativeDelta = FALSE,
    thetaT = 0.5
  )
  expected <- list(
    result = 0.862600867199453,
    table = structure(
      list(
        counts = 0:17,
        cumul_counts = c(
          16, 17, 18, 19, 20, 21, 22, 23, 24, 25,
          26, 27, 28, 29, 30, 31, 32, 33
        )
      ),
      class = "data.frame",
      row.names = c(NA, -18L)
    ),
    density = structure(
      c(
        8.52412582087801e-08, 1.02656308658645e-06,
        6.4290659374686e-06, 2.77819273376663e-05, 9.27624194521215e-05,
        0.000254185451183186, 0.000593244329001435, 0.00120969121688235,
        0.00219670919684321, 0.00360651866587517, 0.0054117299310685,
        0.00744905766596141, 0.00932728742793074, 0.0103632793282697,
        0.00976892747860092, 0.00727193766829246, 0.00377590185827527,
        0.0010227028800183, 1.28745466089596e-07, 1.55048559617968e-06,
        9.71024018219953e-06, 4.19608680012038e-05, 0.000140105169479207,
        0.000383912967422657, 0.000896015840770784, 0.00182707602884687,
        0.00331783405540759, 0.00544716181290601, 0.0081736908507372,
        0.0112508006250159, 0.0140876142902462, 0.0156523408425867, 0.0147546522406727,
        0.010983284669329, 0.00570299236388031, 0.00154465527288012,
        1.84566262625412e-07, 2.2227371606412e-06, 1.39203561419122e-05,
        6.01540451771004e-05, 0.000200851247742439, 0.000550367975842507,
        0.0012845057772298, 0.00261925024949672, 0.00475636346830062,
        0.00780891419527175, 0.0117175976599148, 0.0161288648522795,
        0.0201956495854357, 0.0224388022227119, 0.0211518984171722, 0.0157453607054271,
        0.00817566643978082, 0.00221437895577402, 2.12725689841488e-07,
        2.56186200613139e-06, 1.60441963823987e-05, 6.93317975616464e-05,
        0.000231495288595886, 0.000634338072746135, 0.00148048388518956,
        0.00301887142463579, 0.00548204577336331, 0.00900032668740542,
        0.0135053612184223, 0.0185896590918393, 0.0232769165325628, 0.0258623088214709,
        0.0243790610388104, 0.0181476434003702, 0.00942303462494679,
        0.00255222858304032, 1.95025478448525e-07, 2.34869781753755e-06,
        1.47092110883786e-05, 6.35629246342171e-05, 0.000212233320059432,
        0.000581556868978137, 0.00135729764590056, 0.00276768097169122,
        0.00502590261018102, 0.00825143883520707, 0.0123816241245032,
        0.0170428741412587, 0.0213401201657971, 0.0237103903879651, 0.0223505588194948,
        0.0166376371349773, 0.00863897462284243, 0.00233986596018721,
        1.50420945738261e-07, 1.81152406228109e-06, 1.13450481474481e-05,
        4.90253648570964e-05, 0.000163693159347571, 0.000448548235482792,
        0.00104686832289231, 0.00213468103027094, 0.00387642183896173,
        0.00636424144766735, 0.00954980664782735, 0.013144976065796,
        0.0164593933215478, 0.0182875559355309, 0.0172387332268199, 0.0128324213461875,
        0.00666314341753955, 0.00180471215059739, 1.08669901652556e-07,
        1.30871495803429e-06, 8.19610101755338e-06, 3.54178173216089e-05,
        0.000118258261442191, 0.000324048571807007, 0.000756298114823959,
        0.00154217603459806, 0.0028004768746554, 0.00459777385933042,
        0.00689914921174679, 0.00949643847327524, 0.0118909015279406,
        0.0132116368184373, 0.012453926779804, 0.00927063687048516, 0.0048137121883334,
        0.00130379376990387, 8.40966694861457e-08, 1.01277876950021e-06,
        6.34273877004134e-06, 2.74088816859251e-05, 9.15168393020827e-05,
        0.000250772341064968, 0.000585278459151429, 0.00119344792163063,
        0.00216721258186534, 0.00355809164028129, 0.00533906318283876,
        0.00734903441926285, 0.00920204399268451, 0.0102241249692433,
        0.00963775386081065, 0.0071742927247319, 0.00372520041656062,
        0.00100897039638687, 7.42513389771233e-08, 8.94211152266649e-07,
        5.60018428001204e-06, 2.42000804250728e-05, 8.08028177412345e-05,
        0.000221414025267306, 0.000516758981443618, 0.00105372908014077,
        0.00191349356680623, 0.00314154020734101, 0.00471401058605001,
        0.00648867130117594, 0.00812474610419359, 0.00902717043938133,
        0.00850944672684122, 0.00633438689403671, 0.00328908529407733,
        0.000890848631435348, 7.15986086046781e-08, 8.62264239043604e-07,
        5.40011005730401e-06, 2.33354995401545e-05, 7.79160268529601e-05,
        0.000213503707180074, 0.000498297061912015, 0.00101608317134337,
        0.00184513139890365, 0.00302930439800646, 0.00454559612740306,
        0.0062568546676369, 0.00783447846651987, 0.00870466246132096,
        0.00820543513464688, 0.00610808228140464, 0.00317157823525042,
        0.000859021848855872, 7.11584079160364e-08, 8.56962888651255e-07,
        5.36690924220031e-06, 2.31920288335645e-05, 7.743698557904e-05,
        0.000212191049284065, 0.000495233444977601, 0.00100983611542344,
        0.0018337872104025, 0.00301067970811241, 0.0045176490124442,
        0.00621838643777741, 0.00778631073137362, 0.00865114468374761,
        0.00815498669343737, 0.00607052873003048, 0.00315207882107958,
        0.000853740433241884
      ),
      dim = c(18L, 11L),
      dimnames = list(c(
        "0",
        "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12",
        "13", "14", "15", "16", "17"
      ), c(
        "0", "1", "2", "3", "4", "5",
        "6", "7", "8", "9", "10"
      ))
    ),
    posterior = structure(c(
      0.52573455561724,
      0.616488751200704, 0.701137119489252, 0.775952392725447, 0.838659211176228,
      0.888554115894675, 0.926289066252411, 0.953441218790619, 0.97202824745402,
      0.984104066019821, 0.991505747646935, 0.995747053653525, 0.997999997510637,
      0.999107390045745, 0.9996154790619, 0.999836981545933, 0.999930753331677,
      0.999970126071969, 0.431213175186957, 0.524836049959815, 0.616423615096239,
      0.701253179096434, 0.77576678216646, 0.837963439437157, 0.88740799712246,
      0.924925256553693, 0.952129853182874, 0.970959220330241, 0.983334134016022,
      0.990986033991026, 0.995395956557442, 0.997757262964823, 0.998940828483189,
      0.999505722621467, 0.999768093054447, 0.999889266955351, 0.346498030506,
      0.436678100607708, 0.529057621010935, 0.618667032999986, 0.701182961406303,
      0.773528907849934, 0.834126645572848, 0.882787809532974, 0.920348071326833,
      0.948211585763724, 0.967977079445953, 0.981247558103914, 0.989584948629251,
      0.994461478960191, 0.997133770341094, 0.998529213855604, 0.999239318952544,
      0.999599455693603, 0.268076658107879, 0.349381379851505, 0.436553482218377,
      0.525143560286086, 0.610773266726996, 0.689813971004134, 0.759814217612609,
      0.819588548913437, 0.868996372681918, 0.908544685993715, 0.939020633265324,
      0.961348205772207, 0.976681493321958, 0.986482216638613, 0.992346948813247,
      0.995691134422677, 0.997551758762469, 0.998585725275381, 0.194608254507595,
      0.262224671267671, 0.338135014894269, 0.419063628824853, 0.50136000971226,
      0.58160625522628, 0.657095860913447, 0.726045099200712, 0.787484866030313,
      0.840901902164457, 0.885853671333265, 0.921892450881378, 0.948952311865266,
      0.967822727405505, 0.980122652407415, 0.987761654649906, 0.992397301636149,
      0.995212679470038, 0.127821136613415, 0.178174833741594, 0.237444985500506,
      0.303879855030609, 0.375187389605948, 0.448966058228039, 0.523107503629255,
      0.596016953995806, 0.666527481380265, 0.733484376480996, 0.795210783433181,
      0.849381816841386, 0.893767824435394, 0.927436231794406, 0.951265775387299,
      0.967339951455991, 0.977951371518138, 0.984973868702874, 0.072699052778363,
      0.104976939549021, 0.144899155744351, 0.192095952388592, 0.245795968908976,
      0.305072343858661, 0.369112140295862, 0.437369840093798, 0.509428839912235,
      0.584433190611813, 0.660224566664166, 0.732886788926278, 0.79763324854413,
      0.850858180884959, 0.891630374963095, 0.921418088035421, 0.942750922558018,
      0.958084315642542, 0.0344603160914149, 0.0516562579366225, 0.0740734399340966,
      0.102141424818143, 0.136171377355775, 0.176494078457584, 0.223635098242043,
      0.278418638710105, 0.341801169631591, 0.414187676166124, 0.494212821568556,
      0.57771555690033, 0.658294157211773, 0.729809197668872, 0.788915765531536,
      0.835556244812062, 0.871686726849341, 0.899795690949299, 0.0133766311730364,
      0.0208763042323368, 0.0312223791014647, 0.045010749248294, 0.0629297089429951,
      0.0858669074111429, 0.115057621230866, 0.152202292858466, 0.199369998195786,
      0.25838320660583, 0.329492445986846, 0.409881633390435, 0.493529376871358,
      0.573393369947322, 0.644399086314759, 0.704749472916793, 0.755167896578202,
      0.797480344073255, 0.00426233062698603, 0.00695180797587256,
      0.0108970109044029, 0.0165251948081704, 0.0244133501568159, 0.035385173764153,
      0.0506529097637116, 0.071967426570067, 0.101642261885622, 0.14217064147475,
      0.195144167131462, 0.259716644265444, 0.331871554236271, 0.40573921461525,
      0.476191446023711, 0.540514258007178, 0.598295826449121, 0.650440253864561,
      0.00112143445031975, 0.00192043345912951, 0.00317348228261074,
      0.00509825458349251, 0.00802419185310804, 0.0124665930306964,
      0.0192417580036278, 0.0296131307502522, 0.0453937013811972, 0.0688072932433817,
      0.101833236999242, 0.14504189371855, 0.19670026308091, 0.253236958326675,
      0.310932082238359, 0.36736849975627, 0.421730160342326, 0.474339348900973
    ), dim = c(18L, 11L), dimnames = list(c(
      "0", "1", "2", "3", "4",
      "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15",
      "16", "17"
    ), c(
      "0", "1", "2", "3", "4", "5", "6", "7", "8", "9",
      "10"
    ))),
    success = structure(c(
      TRUE, TRUE, TRUE, TRUE, TRUE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE,
      TRUE, TRUE, FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, FALSE,
      FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE,
      TRUE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE,
      TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE, TRUE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, FALSE,
      FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, FALSE,
      FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,
      TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE,
      FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,
      FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE,
      FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,
      FALSE, FALSE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE,
      FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE,
      FALSE, FALSE, FALSE, FALSE
    ), dim = c(18L, 11L), dimnames = list(
      c(
        "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10",
        "11", "12", "13", "14", "15", "16", "17"
      ),
      c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10")
    ))
  )
  expect_equal(result, expected)
})

test_that("sum of joint density in h_predprobdist is 1", {
  result <- h_predprobdist(
    NmaxControl = 20,
    Nmax = 40,
    n = 23,
    nS = 10,
    x = 16,
    xS = 5,
    parE = rbind(c(1, 1), c(50, 10)),
    parS = rbind(c(1, 1), c(20, 40)),
    weights = c(2, 1),
    weightsS = c(2, 1),
    delta = 0.1,
    relativeDelta = FALSE,
    thetaT = 0.5
  )
  expect_equal(sum(result$density), 1, tolerance = 1e-4)
})

test_that("h_predprobdist give predictive probability less than 1 or 1", {
  result <- h_predprobdist(
    NmaxControl = 20,
    Nmax = 40,
    n = 23,
    nS = 10,
    x = 16,
    xS = 5,
    parE = rbind(c(1, 1), c(50, 10)),
    parS = rbind(c(1, 1), c(20, 40)),
    weights = c(2, 1),
    weightsS = c(2, 1),
    delta = 0.1,
    relativeDelta = FALSE,
    thetaT = 0.5
  )
  expect_true(all(result$posterior <= 1))
})
